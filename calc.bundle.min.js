/* === Калькулятор SansaHome (мини-пакет) 2025 === */
/* 1. Укажите домены, где калькулятор должен работать */
const allowed = ["sansahome.ru", "demo-client.ru"]; 

/* 2. Проверка домена */
if (!allowed.includes(location.hostname)) {
  document.body.innerHTML =
    '<h2 style="text-align:center;margin:50px;font-family:Arial">Калькулятор недоступен</h2>';
  throw new Error("Domain not allowed");
}

/* 3. Весь JS-код калькулятора ― обёрнут в IIFE */
(function () {
"use strict";

/* ---------- БАЗОВЫЕ ДАННЫЕ (можно не трогать) ---------- */
const pricingTable = {
 "24":{"3-11":{"прост":{"100":81000,"50":87000,"30":89000},"видовая":{"100":86000,"50":92000,"30":94000}},"12-19":{"прост":{"100":73000,"50":78000,"30":80000},"видовая":{"100":78000,"50":83000,"30":85000}},"20-24":{"прост":{"100":71000,"50":76000,"30":78000},"видовая":{"100":78000,"50":83000,"30":85000}}},
 "36":{"3-11":{"прост":{"100":81000,"50":91000,"30":95000},"видовая":{"100":86000,"50":96000,"30":100000}},"12-19":{"прост":{"100":73000,"50":82000,"30":85000},"видовая":{"100":78000,"50":87000,"30":90000}},"20-24":{"прост":{"100":71000,"50":79000,"30":83000},"видовая":{"100":78000,"50":87000,"30":90000}}},
 "48":{"3-11":{"прост":{"100":81000,"50":93000,"30":98000},"видовая":{"100":86000,"50":98000,"30":103000}},"12-19":{"прост":{"100":73000,"50":83000,"30":88000},"видовая":{"100":78000,"50":88000,"30":93000}},"20-24":{"прост":{"100":71000,"50":81000,"30":85000},"видовая":{"100":78000,"50":88000,"30":93000}}}
};

const apartments = [
  {area:48.9,type:"прост",images:["https://static.tildacdn.com/tild6337-3331-4766-b730-373836373634/1_489_.png"]},
  {area:48.9,type:"прост",images:["https://static.tildacdn.com/tild6262-3939-4039-a531-633437613162/1_489_.png"]},
  {area:57.9,type:"прост",images:["https://static.tildacdn.com/tild3466-6337-4462-a634-306136386330/1_579_.png"]},
  {area:57.2,type:"прост",images:["https://static.tildacdn.com/tild3830-6462-4036-b661-663165363063/1_572_.png"]},
  {area:74,type:"прост",images:["https://static.tildacdn.com/tild3335-3861-4031-b131-613132313532/3_74_.png"]},
  {area:74,type:"прост",images:["https://static.tildacdn.com/tild3234-3230-4261-a132-653566626664/3_74_.png"]},
  {area:48.9,type:"видовая",images:["https://static.tildacdn.com/tild3761-6332-4739-b139-633538383332/1489_.png"]},
  {area:48.9,type:"видовая",images:["https://static.tildacdn.com/tild6235-3965-4461-b933-653863666136/1_489_.png"]},
  {area:82.6,type:"видовая",images:["https://static.tildacdn.com/tild6565-3434-4662-b036-663165323832/3_826_.png"]},
  {area:82.1,type:"видовая",images:["https://static.tildacdn.com/tild6662-3538-4564-a239-626166363661/3_821_.png"]}
];

/* ---------- НАСТРОЙКИ ---------- */
let whatsappNumber = '79298889930';  // по умолчанию
const SPREADSHEET_ID = '1rCQ0Me6eUSltHYKKodXCaEgHfotV7BcvGOc5nM9ym0I'; // <-- замените при желании

/* ---------- ГЕНЕРАЦИЯ КАРТОЧЕК ---------- */
const cardsContainer = document.getElementById("cardsContainer");
apartments.forEach((ap, index) => {
  const autoView = /вид/.test(ap.type.toLowerCase()) || /вид|vid/.test(ap.images[0]);
  const card = document.createElement("div");
  card.classList.add("result-card");
  card.innerHTML = `
    <div class="apartment-image"><img src="${ap.images[0]}" alt="Планировка"></div>
    <div class="apartment-stats"><div class="stat-value">${ap.area}</div><div class="stat-label">кв.м</div></div>
    <div class="calc-block"><div class="payment-label">Первоначальный взнос</div>
      <div class="payment-options">
        <label class="radio-option"><input type="radio" name="down-${index}" value="100" checked><span>100%</span></label>
        <label class="radio-option"><input type="radio" name="down-${index}" value="50"><span>50%</span></label>
        <label class="radio-option"><input type="radio" name="down-${index}" value="30"><span>30%</span></label>
      </div>
    </div>
    <div class="calc-block"><div class="installment-label">Срок рассрочки (мес)</div>
      <div class="installment-options">
        <label class="radio-option"><input type="radio" name="inst-${index}" value="24"><span>24</span></label>
        <label class="radio-option"><input type="radio" name="inst-${index}" value="36"><span>36</span></label>
        <label class="radio-option"><input type="radio" name="inst-${index}" value="48"><span>48</span></label>
      </div>
    </div>
    <div class="calc-block"><div class="floor-label">Этажность</div>
      <div class="floor-options">
        <label class="radio-option"><input type="radio" name="floor-${index}" value="3-11" checked><span>3-11</span></label>
        <label class="radio-option"><input type="radio" name="floor-${index}" value="12-19"><span>12-19</span></label>
        <label class="radio-option"><input type="radio" name="floor-${index}" value="20-24"><span>20-24</span></label>
      </div>
    </div>
    ${autoView ? `<div class="calc-block"><div class="type-label">Вид из окон</div><div style="text-align:center;font-weight:bold;">С видом на проспект В.В. Путина</div></div>` : ""}
    <button class="btn-calc" id="calc-${index}">Рассчитать</button>
    <div class="warning" id="warn-${index}">Чтобы рассчитать, заполните данные</div>
    <button class="btn-detail" id="wa-${index}" disabled>Отправить на WhatsApp</button>
    <div class="warning" id="wawarn-${index}">Сначала рассчитайте стоимость</div>
    <div class="price-info" id="res-${index}" style="display:none">
      <div class="price-col"><div class="price-label">Цена за м²</div><div class="price-value" id="m2-${index}"></div></div>
      <div class="price-col"><div class="price-label">Стоимость</div><div class="price-value" id="tot-${index}"></div></div>
      <div class="price-col"><div class="price-label">Перв. взнос</div><div class="price-value" id="init-${index}"></div></div>
      <div class="price-col"><div class="price-label">Ежемесячно</div><div class="price-value" id="mon-${index}"></div></div>
    </div>`;
  cardsContainer.appendChild(card);

  /* логика блокировки/расчёта */
  const updInst = () => {
    const down = document.querySelector(`input[name="down-${index}"]:checked`).value;
    document.querySelectorAll(`input[name="inst-${index}"]`).forEach((r,i)=>{
      if (down==="100"){r.disabled=true;r.checked=false}
      else {r.disabled=false;if(!document.querySelector(`input[name="inst-${index}"]:checked`)) r.checked=i===0;}
    });
  };
  document.querySelectorAll(`input[name="down-${index}"]`).forEach(r=>r.addEventListener("change",updInst));
  updInst();

  const calc = () => {
    const down = document.querySelector(`input[name="down-${index}"]:checked`).value;
    const floor = document.querySelector(`input[name="floor-${index}"]:checked`).value;
    const instRadio = document.querySelector(`input[name="inst-${index}"]:checked`);
    const inst = down==="100" ? "0" : (instRadio ? instRadio.value : "0");
    const view = autoView ? "видовая" : "прост";
    const m2 = inst==="0" ? pricingTable["24"][floor][view]["100"] : pricingTable[inst][floor][view][down];
    const tot = m2*ap.area, downRub = tot*(+down)/100, mon = inst==="0" ? 0 : (tot-downRub)/inst;
    document.getElementById(`m2-${index}`).textContent = m2.toLocaleString()+" ₽";
    document.getElementById(`tot-${index}`).textContent = Math.round(tot).toLocaleString()+" ₽";
    document.getElementById(`init-${index}`).textContent = down==="100" ? "Полная оплата" : Math.round(downRub).toLocaleString()+" ₽";
    document.getElementById(`mon-${index}`).textContent  = inst==="0" ? "—" : Math.round(mon).toLocaleString()+" ₽";
    document.getElementById(`res-${index}`).style.display="flex";
    document.getElementById(`wa-${index}`).disabled=false;
  };
  document.getElementById(`calc-${index}`).addEventListener("click",calc);

  document.getElementById(`wa-${index}`).addEventListener("click",function(){
    if(this.disabled){
      document.getElementById(`wawarn-${index}`).style.display="block";
      setTimeout(()=>document.getElementById(`wawarn-${index}`).style.display="none",2000);
      return;
    }
    const down=document.querySelector(`input[name="down-${index}"]:checked`).value;
    const floor=document.querySelector(`input[name="floor-${index}"]:checked`).value;
    const instRadio=document.querySelector(`input[name="inst-${index}"]:checked`);
    const inst=down==="100"?"0":(instRadio?instRadio.value:"0");
    const msg=`Здравствуйте! Меня заинтересовал вариант:
• Площадь: ${ap.area} м²
• Первоначальный взнос: ${down==="100"?"100 % (полная оплата)":down+" %"}
• Рассрочка: ${inst==="0"?"нет":inst+" мес"}
• Этажность: ${floor}
• Вид: ${autoView?"на проспект":"обычный"}
Ссылка на планировку: ${ap.images[0]}`;
    window.open("https://wa.me/"+whatsappNumber+"?text="+encodeURIComponent(msg),"_blank");
  });
});

/* ---------- ПОДКЛЮЧЕНИЕ GOOGLE SHEETS ---------- */
/* Цены */
fetch(`https://opensheet.elk.sh/${SPREADSHEET_ID}/Prices`)
 .then(r=>r.json())
 .then(rows=>{
   const dyn={};
   rows.forEach(({installment,floor,view,downpayment,price})=>{
     dyn[installment]??={};
     dyn[installment][floor]??={};
     dyn[installment][floor][view]??={};
     dyn[installment][floor][view][downpayment]=+price;
   });
   Object.assign(pricingTable,dyn);
 })
 .catch(err=>console.error("Ошибка загрузки цен:",err));

/* Номер WhatsApp */
fetch(`https://opensheet.elk.sh/${SPREADSHEET_ID}/Config`)
 .then(r=>r.json())
 .then(rows=>{
   const row=rows.find(r=>String(r.key).toLowerCase()==='whatsapp');
   if(row&&row.value) whatsappNumber=row.value.replace(/\D/g,'');
 })
 .catch(err=>console.error("Ошибка получения номера WhatsApp:",err));

})(); /* конец IIFE */
